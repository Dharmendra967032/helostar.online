<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Helostar | Full Experience</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #111111;
            --helostar-pink: #d3159d;
            --text-white: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-white); margin: 0; padding: 0; }
        
        /* Full Screen Auth */
        #authOverlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        
        header { background: rgba(0,0,0,0.9); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--glass); }
        .logo { font-size: 1.5rem; font-weight: 900; color: var(--helostar-pink); }

        /* Navigation Tabs */
        .nav-tabs { display: flex; width: 100%; border-bottom: 1px solid var(--glass); }
        .tab-btn { flex: 1; padding: 15px; background: none; border: none; color: #888; font-weight: bold; cursor: pointer; border-bottom: 2px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: var(--helostar-pink); border-bottom-color: var(--helostar-pink); }

        /* Global Container - Full Width on Mobile */
        .container { width: 100%; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

        /* Full Screen / Responsive Video Cards */
        .card { width: 100%; background: var(--card-bg); margin-bottom: 15px; border-bottom: 1px solid var(--glass); }
        
        /* FIXED 355px for Full Videos */
        .video-wrap-full { width: 100%; height: 355px; background: #000; display: flex; align-items: center; justify-content: center; }
        
        /* Adaptive Height for Shorts (Mobile Full-ish) */
        .video-wrap-short { width: 100%; aspect-ratio: 9/16; background: #000; }
        
        video { width: 100%; height: 100%; object-fit: contain; }

        .info-area { padding: 15px; }
        .actions { display: flex; gap: 25px; padding-top: 10px; }
        .btn-act { cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; color: #ccc; }
        .btn-act.liked { color: var(--helostar-pink); }

        /* Comments List UI */
        .comment-box { background: #0a0a0a; padding: 15px; border-radius: 10px; margin-top: 12px; display: none; }
        .comment-list { max-height: 200px; overflow-y: auto; margin-bottom: 10px; font-size: 0.85rem; }
        .comment-item { margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #222; }

        /* Inputs */
        .c-input { flex: 1; background: #222; border: 1px solid #444; padding: 10px; color: white; border-radius: 5px; }
        .c-btn { background: var(--helostar-pink); border: none; padding: 10px 15px; color: white; border-radius: 5px; font-weight: bold; }
        
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: var(--helostar-pink); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 999; }
        
        .hidden { display: none !important; }
        .guest-lock { opacity: 0.4; pointer-events: none; }
    </style>
</head>
<body>

    <div id="authOverlay">
        <h1 style="color:var(--helostar-pink); font-size: 3rem;">HELOSTAR</h1>
        <button class="c-btn" style="width: 250px; margin-bottom: 10px;" onclick="signInWithGoogle()">Google Login</button>
        <button class="c-btn" style="width: 250px; background: #333;" onclick="guestMode()">Guest Access</button>
    </div>

    <header>
        <div class="logo">HELOSTAR</div>
        <button id="logoutBtn" class="c-btn" style="background:none; border:1px solid #444; display:none" onclick="logout()">Logout</button>
    </header>

    <div class="nav-tabs">
        <button id="tShort" class="tab-btn active" onclick="setTab('short')">SHORTS</button>
        <button id="tFull" class="tab-btn" onclick="setTab('full')">VIDEOS</button>
    </div>

    <div class="container">
        <div id="feed"></div>
    </div>

    <input type="file" id="fileIn" style="display:none" accept="video/*">
    <button id="uploadBtn" class="fab" onclick="document.getElementById('fileIn').click()"><i class="fa fa-plus"></i></button>

<script>
    const SUPABASE_URL = "https://axufucktgyuorwqcykkq.supabase.co"; 
    const SUPABASE_ANON_KEY = "sb_publishable_Vuq82ePGI4vrov2ObLhJQQ_eZRtgkG5"; 

    firebase.initializeApp({
      apiKey: "AIzaSyAd_Gds3NO1NuiWWE7kOUST_epBn_cs2xY",
      authDomain: "helostar-134d9.firebaseapp.com",
      projectId: "helostar-134d9"
    });

    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUserEmail = null;
    let currentTab = 'short';
    let isGuest = false;

    firebase.auth().onAuthStateChanged(user => {
        if (user) { currentUserEmail = user.email; isGuest = false; start(); }
        else if (localStorage.getItem('guest')) { isGuest = true; start(); }
    });

    function start() {
        document.getElementById('authOverlay').classList.add('hidden');
        document.getElementById('logoutBtn').style.display = 'block';
        if(!isGuest) document.getElementById('uploadBtn').style.display = 'flex';
        renderFeed();
    }

    function setTab(t) {
        currentTab = t;
        document.getElementById('tShort').classList.toggle('active', t === 'short');
        document.getElementById('tFull').classList.toggle('active', t === 'full');
        renderFeed();
    }

    async function renderFeed() {
        const feed = document.getElementById('feed');
        feed.innerHTML = '<p style="text-align:center; padding:20px;">Loading Feed...</p>';

        const { data: videos } = await _supabase.from('videos').select('*').order('created_at', {ascending: false});
        let myLikes = [];
        if (currentUserEmail) {
            const { data: lks } = await _supabase.from('likes').select('video_id').eq('user_email', currentUserEmail);
            myLikes = lks.map(l => l.video_id);
        }

        feed.innerHTML = '';
        videos.forEach(v => {
            const vTemp = document.createElement('video');
            vTemp.src = v.url;
            vTemp.onloadedmetadata = () => {
                const isVertical = vTemp.videoHeight > vTemp.videoWidth;
                if ((currentTab === 'short' && isVertical) || (currentTab === 'full' && !isVertical)) {
                    createCard(v, myLikes.includes(v.id), isVertical);
                }
            };
        });
    }

    function createCard(v, hasLiked, isVertical) {
        const card = document.createElement('div');
        card.className = 'card';
        const wrapType = isVertical ? 'video-wrap-short' : 'video-wrap-full';
        
        card.innerHTML = `
            <div class="${wrapType}"><video src="${v.url}" ${!isVertical ? 'controls' : 'loop muted onclick="this.play()"' }></video></div>
            <div class="info-area">
                <div style="font-weight:bold; margin-bottom:10px;">${v.description}</div>
                <div class="actions">
                    <div class="btn-act ${isGuest ? 'guest-lock' : ''} ${hasLiked ? 'liked' : ''}" onclick="doLike(${v.id}, this)">
                        <i class="fas fa-heart"></i> <span id="lc-${v.id}">${v.likes || 0}</span>
                    </div>
                    <div class="btn-act ${isGuest ? 'guest-lock' : ''}" onclick="viewComm(${v.id})">
                        <i class="fas fa-comment"></i> Comment
                    </div>
                </div>
                <div id="cb-${v.id}" class="comment-box">
                    <div id="cl-${v.id}" class="comment-list"></div>
                    <div style="display:flex; gap:8px">
                        <input type="text" id="ci-${v.id}" class="c-input" placeholder="Type a comment...">
                        <button class="c-btn" onclick="sendComm(${v.id})">Post</button>
                    </div>
                </div>
            </div>`;
        document.getElementById('feed').appendChild(card);
    }

    async function doLike(vid, btn) {
        if (isGuest || btn.classList.contains('liked')) return;
        const { error } = await _supabase.from('likes').insert([{ video_id: vid, user_email: currentUserEmail }]);
        if (error) return;

        const { data } = await _supabase.from('videos').select('likes').eq('id', vid).single();
        await _supabase.from('videos').update({ likes: (data.likes || 0) + 1 }).eq('id', vid);
        btn.classList.add('liked');
        document.getElementById(`lc-${vid}`).innerText = (data.likes || 0) + 1;
    }

    function viewComm(vid) {
        const box = document.getElementById(`cb-${vid}`);
        box.style.display = box.style.display === 'block' ? 'none' : 'block';
        if (box.style.display === 'block') refreshComm(vid);
    }

    async function refreshComm(vid) {
        const { data } = await _supabase.from('comments').select('*').eq('video_id', vid).order('created_at', {ascending: false});
        document.getElementById(`cl-${vid}`).innerHTML = data.map(c => `<div class="comment-item"><b>${c.user_name}:</b> ${c.comment_text}</div>`).join('');
    }

    async function sendComm(vid) {
        const val = document.getElementById(`ci-${vid}`).value;
        if (!val.trim()) return;
        await _supabase.from('comments').insert([{ video_id: vid, user_name: currentUserEmail.split('@')[0], comment_text: val }]);
        document.getElementById(`ci-${vid}`).value = '';
        refreshComm(vid);
    }

    document.getElementById('fileIn').addEventListener('change', async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const btn = document.getElementById('uploadBtn');
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
        const name = `${Date.now()}_${f.name}`;
        await _supabase.storage.from('videos').upload(name, f);
        const { data } = _supabase.storage.from('videos').getPublicUrl(name);
        await _supabase.from('videos').insert([{ url: data.publicUrl, description: prompt("Caption:"), owner: currentUserEmail, likes: 0 }]);
        location.reload();
    });

    function guestMode() { localStorage.setItem('guest', '1'); location.reload(); }
    function logout() { localStorage.clear(); firebase.auth().signOut().then(() => location.reload()); }
    function signInWithGoogle() { firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
</script>
</body>
</html>