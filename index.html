<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Helostar | Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-color: #000;
            --helostar-pink: #d3159d;
            --glass-white: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.15);
            --blur: blur(25px);
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: #fff; margin: 0; overflow-x: hidden; }
        header { background: rgba(0,0,0,0.8); backdrop-filter: var(--blur); padding: 12px 20px; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--glass-border); }
        .header-content { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .logo { font-size: 1.5rem; font-weight: 900; color: var(--helostar-pink); }

        /* Expandable Search */
        .search-container { position: relative; display: flex; align-items: center; transition: 0.4s; width: 40px; }
        .search-container.expanded { width: 100%; }
        .search-bar { width: 0; opacity: 0; background: var(--glass-white); border: 1px solid var(--glass-border); border-radius: 20px; padding: 8px; color: white; outline: none; transition: 0.4s; }
        .search-container.expanded .search-bar { width: 100%; opacity: 1; padding-left: 35px; }
        .search-icon-btn { cursor: pointer; position: absolute; left: 10px; z-index: 5; }

        /* Menu */
        .dropdown-content { position: absolute; right: 20px; top: 60px; background: #111; border: 1px solid var(--glass-border); border-radius: 15px; min-width: 200px; display: none; flex-direction: column; z-index: 2000; }
        .dropdown-content.show { display: flex; }
        .dropdown-item { padding: 12px 15px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .logout-item { color: #ff4d4d; justify-content: center; font-size: 1.2rem; border: none; }

        /* Tabs */
        .nav-tabs { display: flex; background: #000; position: sticky; top: 60px; z-index: 900; }
        .tab-btn { flex: 1; padding: 15px; background: none; border: none; color: #555; font-weight: 700; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab-btn.active { color: #fff; border-bottom-color: var(--helostar-pink); }

        /* Feed */
        .container { width: 100%; max-width: 500px; margin: 0 auto; }
        .card { width: 100%; margin-bottom: 20px; border-bottom: 1px solid #111; scroll-snap-align: start; }
        .v-wrap { width: 100%; background: #000; position: relative; aspect-ratio: 9/16; overflow: hidden; }
        .v-full-mode { height: 400px; aspect-ratio: auto; }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* Actions */
        .action-row { display: flex; gap: 10px; padding: 15px; }
        .btn-act { cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 14px; border-radius: 25px; background: var(--glass-white); border: 1px solid var(--glass-border); font-size: 0.8rem; color: white; }
        .btn-act.liked { color: var(--helostar-pink); border-color: var(--helostar-pink); }

        /* Comments Panel */
        .comm-panel { margin: 10px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px; display: none; }
        .comm-list { max-height: 200px; overflow-y: auto; font-size: 0.85rem; margin-bottom: 10px; }
        .comm-input-wrap { display: flex; gap: 8px; }
        .comm-input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 8px; outline: none; }

        .heart-pop { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); color: white; font-size: 80px; pointer-events: none; z-index: 10; opacity: 0; }
        .animate-heart { animation: heartFade 0.7s; }
        @keyframes heartFade { 0% { scale:0; opacity:0; } 50% { scale:1.2; opacity:0.9; } 100% { scale:1; opacity:0; } }

        .fab { position: fixed; bottom: 30px; right: 25px; width: 60px; height: 60px; background: var(--helostar-pink); border-radius: 50%; display: none; align-items: center; justify-content: center; color: white; z-index: 1001; cursor: pointer; box-shadow: 0 4px 15px var(--helostar-pink); }
        #authOverlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="authOverlay">
        <h1 class="logo" style="font-size: 3rem;">HELOSTAR</h1>
        <button onclick="signInWithGoogle()" class="btn-act" style="background:#fff; color:#000; margin-top:20px; padding: 15px 30px;">Login with Google</button>
        <button onclick="guestMode()" class="btn-act" style="margin-top:10px; background:none;">Guest Mode</button>
    </div>

    <header>
        <div class="header-content">
            <div class="logo" id="headerLogo">HELOSTAR</div>
            <div class="search-container" id="searchContainer">
                <i class="fas fa-search search-icon-btn" onclick="toggleSearch()"></i>
                <input type="text" id="searchInput" class="search-bar" placeholder="Search..." oninput="renderFeed()">
            </div>
            <i class="fas fa-bars" style="font-size:1.5rem; cursor:pointer;" onclick="toggleMenu()"></i>
        </div>
    </header>

    <div class="dropdown-content" id="catDropdown">
        <div class="dropdown-item" id="userDisplay" style="color:var(--helostar-pink); font-weight: bold;">Guest</div>
        <div class="dropdown-item" onclick="filterByCat('All')">All Videos</div>
        <div class="dropdown-item" onclick="filterByCat('Comedy')">Comedy</div>
        <div class="dropdown-item" onclick="filterByCat('Party')">Party</div>
        <div class="dropdown-item" onclick="filterByCat('Tech')">Tech</div>
        <div class="dropdown-item" style="opacity: 0.5;">Download App (Link Soon)</div>
        <div class="dropdown-item logout-item" onclick="logout()"><i class="fas fa-power-off"></i></div>
    </div>

    <div class="nav-tabs">
        <button id="tShort" class="tab-btn active" onclick="setTab('short')">SHORTS</button>
        <button id="tFull" class="tab-btn" onclick="setTab('full')">VIDEOS</button>
    </div>

    <div class="container" id="feed"></div>

    <input type="file" id="fileIn" style="display:none" accept="video/*">
    <button id="uploadBtn" class="fab" onclick="document.getElementById('fileIn').click()"><i class="fa fa-plus"></i></button>

<script>
    const SUPABASE_URL = "https://axufucktgyuorwqcykkq.supabase.co"; 
    const SUPABASE_ANON_KEY = "sb_publishable_Vuq82ePGI4vrov2ObLhJQQ_eZRtgkG5"; 
    firebase.initializeApp({ apiKey: "AIzaSyAd_Gds3NO1NuiWWE7kOUST_epBn_cs2xY", authDomain: "helostar-134d9.firebaseapp.com", projectId: "helostar-134d9" });
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUserEmail = null, currentTab = 'short', currentCat = 'All', isGuest = false;

    // UI Logic
    function toggleSearch() {
        const c = document.getElementById('searchContainer');
        c.classList.toggle('expanded');
        document.getElementById('headerLogo').style.display = c.classList.contains('expanded') ? 'none' : 'block';
    }
    function toggleMenu() { document.getElementById('catDropdown').classList.toggle('show'); }

    // Scroll Observer for Playback
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            const video = entry.target.querySelector('video');
            if (entry.isIntersecting) video.play();
            else { video.pause(); video.currentTime = 0; }
        });
    }, { threshold: 0.8 });

    // Auth
    firebase.auth().onAuthStateChanged(user => {
        if (user) { 
            currentUserEmail = user.email;
            document.getElementById('userDisplay').innerText = user.displayName || user.email.split('@')[0];
            start(false); 
        } else if (localStorage.getItem('guest')) { start(true); }
    });

    function start(g) {
        isGuest = g;
        document.getElementById('authOverlay').classList.add('hidden');
        if(!isGuest) document.getElementById('uploadBtn').style.display = 'flex';
        renderFeed();
    }

    async function renderFeed() {
        const feed = document.getElementById('feed');
        feed.innerHTML = '<p style="text-align:center; padding:50px; opacity:0.5;">Loading Feed...</p>';
        
        let q = _supabase.from('videos').select('*').order('created_at', {ascending: false});
        if (currentCat !== 'All') q = q.eq('category', currentCat);
        
        const { data: videos } = await q;
        feed.innerHTML = '';

        for (const v of videos) {
            const vTemp = document.createElement('video');
            vTemp.src = v.url;
            vTemp.onloadedmetadata = async () => {
                const isVertical = vTemp.videoHeight > vTemp.videoWidth;
                if ((currentTab === 'short' && isVertical) || (currentTab === 'full' && !isVertical)) {
                    // Fetch real-time comment count
                    const { count } = await _supabase.from('comments').select('*', { count: 'exact', head: true }).eq('video_id', v.id);
                    createCard(v, isVertical, count || 0);
                }
            };
        }
    }

    function createCard(v, isVertical, cCount) {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="v-wrap ${!isVertical ? 'v-full-mode' : ''}" ondblclick="handleDoubleTap(${v.id}, this)">
                <div class="heart-pop" id="heart-${v.id}"><i class="fas fa-heart"></i></div>
                <video src="${v.url}" id="vid-${v.id}" loop muted playsinline preload="metadata" 
                       onended="playNext(${v.id})" onplay="incView(${v.id})"></video>
            </div>
            <div class="action-row">
                <div class="btn-act" id="l-${v.id}" onclick="doLike(${v.id})"><i class="fas fa-heart"></i> <span>${v.likes || 0}</span></div>
                <div class="btn-act" onclick="toggleComments(${v.id})"><i class="fas fa-comment"></i> <span id="cc-${v.id}">${cCount}</span></div>
                <div class="btn-act"><i class="fas fa-eye"></i> <span id="v-${v.id}">${v.views || 0}</span></div>
                <div class="btn-act" onclick="share('${v.url}')"><i class="fas fa-paper-plane"></i></div>
            </div>
            <div style="padding:0 15px 15px;"><b>@${v.owner?.split('@')[0]}</b> ${v.description}</div>
            
            <div id="cp-${v.id}" class="comm-panel">
                <div class="comm-list" id="cl-${v.id}">Loading comments...</div>
                <div class="comm-input-wrap">
                    <input type="text" id="ci-${v.id}" class="comm-input" placeholder="Add a comment...">
                    <button class="btn-act" style="background:var(--helostar-pink); border:none;" onclick="postComment(${v.id})">Post</button>
                </div>
            </div>`;
        
        document.getElementById('feed').appendChild(card);
        observer.observe(card);
    }

    // Comment Logic
    async function toggleComments(vid) {
        const panel = document.getElementById(`cp-${vid}`);
        const isOpening = panel.style.display !== 'block';
        panel.style.display = isOpening ? 'block' : 'none';
        if (isOpening) loadComments(vid);
    }

    async function loadComments(vid) {
        const list = document.getElementById(`cl-${vid}`);
        const { data } = await _supabase.from('comments').select('*').eq('video_id', vid).order('created_at', {ascending: false});
        list.innerHTML = data.length ? data.map(c => `<div><strong>@${c.user_name}:</strong> ${c.comment_text}</div>`).join('') : 'No comments yet.';
        document.getElementById(`cc-${vid}`).innerText = data.length;
    }

    async function postComment(vid) {
        if (isGuest) return alert("Please login to comment");
        const input = document.getElementById(`ci-${vid}`);
        const text = input.value.trim();
        if (!text) return;

        await _supabase.from('comments').insert([{ 
            video_id: vid, 
            user_name: currentUserEmail.split('@')[0], 
            comment_text: text 
        }]);

        input.value = '';
        loadComments(vid);
    }

    // Like & View Logic
    async function handleDoubleTap(vid, el) {
        const h = document.getElementById(`heart-${vid}`);
        h.classList.add('animate-heart');
        setTimeout(() => h.classList.remove('animate-heart'), 700);
        
        const video = el.querySelector('video');
        if (video.requestFullscreen) video.requestFullscreen();
        else if (video.webkitRequestFullscreen) video.webkitRequestFullscreen();
        
        doLike(vid);
    }

    async function doLike(vid) {
        if (isGuest) return;
        const { data } = await _supabase.from('videos').select('likes').eq('id', vid).single();
        await _supabase.from('videos').update({ likes: (data.likes || 0) + 1 }).eq('id', vid);
        document.querySelector(`#l-${vid} span`).innerText = (data.likes || 0) + 1;
    }

    async function incView(vid) {
        const { data } = await _supabase.from('videos').select('views').eq('id', vid).single();
        await _supabase.from('videos').update({ views: (data.views || 0) + 1 }).eq('id', vid);
        document.getElementById(`v-${vid}`).innerText = (data.views || 0) + 1;
    }

    function playNext(currentId) {
        const cards = Array.from(document.querySelectorAll('.card'));
        const currentIndex = cards.findIndex(c => c.querySelector('video').id === `vid-${currentId}`);
        if (currentIndex < cards.length - 1) {
            cards[currentIndex + 1].scrollIntoView({ behavior: 'smooth' });
        }
    }

    function setTab(t) { currentTab = t; renderFeed(); }
    function filterByCat(c) { currentCat = c; toggleMenu(); renderFeed(); }
    function share(url) { navigator.clipboard.writeText(url); alert("Link Copied!"); }
    function logout() { localStorage.clear(); firebase.auth().signOut().then(() => location.reload()); }
    function guestMode() { localStorage.setItem('guest', '1'); location.reload(); }
    function signInWithGoogle() { firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

    // Close menu on click outside
    window.onclick = function(e) {
        if (!e.target.matches('.fa-bars')) {
            const d = document.getElementById('catDropdown');
            if (d.classList.contains('show')) d.classList.remove('show');
        }
    }
</script>
</body>
</html>